# Спливання та занурення подій в JavaScript

Коли подія відбувається на елементі, вона не тільки обробляється на цьому елементі, але і "подорожує" по DOM-дереву. Цей процес має дві фази: занурення (capturing) і спливання (bubbling).

## Фази поширення події

Згідно зі специфікацією DOM Events, існує три фази поширення події:

1. **Фаза занурення (Capturing phase)** - подія спускається від кореневого елемента до цільового
2. **Цільова фаза (Target phase)** - подія досягає цільового елемента
3. **Фаза спливання (Bubbling phase)** - подія піднімається від цільового елемента до кореневого

```
                    | Фаза 1: Занурення (Capturing) |
                    v                               v
html -> body -> div -> p -> span (цільовий елемент)
                    ^                               ^
                    | Фаза 3: Спливання (Bubbling)  |
```

## Спливання подій (Event Bubbling)

Спливання - це процес, коли подія спочатку обробляється на цільовому елементі, а потім на його батьківських елементах, піднімаючись вгору по DOM-дереву.

Розглянемо приклад з вкладеними елементами:

```html
<form onclick="alert('form')">FORM
  <div onclick="alert('div')">DIV
    <p onclick="alert('p')">P</p>
  </div>
</form>
```

Якщо клікнути на елемент `<p>`, то події будуть оброблені в такому порядку:
1. Спочатку спрацює обробник на `<p>`
2. Потім на `<div>`
3. Потім на `<form>`
4. І так далі вгору до `document`

Тобто, подія "спливає" від внутрішнього елемента до зовнішніх, як бульбашка у воді.

### Не всі події спливають

Більшість подій спливають, але є винятки:
- `focus`
- `blur`
- `mouseenter`
- `mouseleave`
- `load`
- `unload`
- `resize`
- `scroll` (в деяких випадках)

## Зупинка спливання

Іноді потрібно зупинити спливання події, щоб вона не оброблялася батьківськими елементами. Для цього використовується метод `event.stopPropagation()`:

```javascript
element.addEventListener("click", function(event) {
  event.stopPropagation();
  console.log("Ця подія не спливе вище");
});
```

Приклад:

```html
<body onclick="alert('Спливання не дійде сюди')">
  <button onclick="event.stopPropagation()">Натисни мене</button>
</body>
```

Якщо елемент має кілька обробників на одну подію, то `stopPropagation()` не зупинить виконання інших обробників на цьому ж елементі. Для цього використовується метод `event.stopImmediatePropagation()`.

### Коли варто використовувати stopPropagation()

Зупинка спливання може бути корисною в таких випадках:
- Коли потрібно обробити подію тільки на конкретному елементі
- Для запобігання конфліктів між обробниками на різних рівнях DOM
- У випадках, коли батьківські обробники можуть заважати роботі дочірніх

Однак слід бути обережним із зупинкою спливання, оскільки це може порушити роботу інших скриптів, які розраховують на спливання подій.

## Занурення подій (Event Capturing)

Занурення - це процес, протилежний спливанню. Подія спочатку обробляється на кореневому елементі, потім на його дочірніх елементах, і так далі вниз до цільового елемента.

За замовчуванням обробники подій реєструються для фази спливання. Щоб зареєструвати обробник для фази занурення, потрібно встановити третій параметр `addEventListener` в `true` або об'єкт з `capture: true`:

```javascript
element.addEventListener("click", handler, true); // Старий синтаксис
element.addEventListener("click", handler, { capture: true }); // Новий синтаксис
```

Приклад:

```javascript
// Фаза занурення (перехоплення)
document.querySelector("form").addEventListener("click", function() {
  console.log("form - фаза занурення");
}, true);

document.querySelector("div").addEventListener("click", function() {
  console.log("div - фаза занурення");
}, true);

// Фаза спливання
document.querySelector("form").addEventListener("click", function() {
  console.log("form - фаза спливання");
});

document.querySelector("div").addEventListener("click", function() {
  console.log("div - фаза спливання");
});
```

Якщо клікнути на `<div>`, порядок виконання буде таким:
1. `form - фаза занурення`
2. `div - фаза занурення`
3. `div - фаза спливання`
4. `form - фаза спливання`

## Порядок виконання обробників

Якщо на одному елементі є обробники для обох фаз (занурення і спливання), то порядок їх виконання буде таким:
1. Обробники фази занурення (зверху вниз)
2. Обробники на цільовому елементі
3. Обробники фази спливання (знизу вгору)

## Практичне застосування

### Делегування подій

Спливання подій дозволяє реалізувати делегування подій - потужний патерн, коли замість призначення обробників кожному елементу, ми призначаємо один обробник їх спільному предку:

```javascript
document.querySelector("ul").addEventListener("click", function(event) {
  if (event.target.tagName === "LI") {
    console.log("Клік на елементі списку:", event.target.textContent);
  }
});
```

### Використання фази занурення

Фаза занурення рідко використовується, але може бути корисною в деяких випадках:
- Для відстеження всіх кліків на сторінці
- Для реалізації власних систем подій
- Для перехоплення подій до того, як вони досягнуть цільового елемента

## Найкращі практики

1. **Розуміння спливання** - завжди пам'ятайте про спливання подій при розробці обробників
2. **Використовуйте делегування** - це ефективніше, ніж призначення обробників кожному елементу
3. **Обережно з stopPropagation()** - використовуйте тільки коли це дійсно необхідно
4. **Перевіряйте event.target** - для визначення, на якому елементі відбулася подія
5. **Використовуйте фазу занурення** тільки коли це дійсно потрібно

У наступному розділі ми детальніше розглянемо делегування подій як потужний патерн для ефективної обробки подій.
